<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactional Outbox | Control Plane</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0d1117;
            --surface: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --text-dim: #8b949e;
            --primary: #58a6ff;
            --success: #2ea043;
            --warning: #d29922;
            --error: #f85149;
            --accent: #bc8cff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-y: auto;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 1.5rem;
            flex: 1;
            min-height: 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo span {
            color: var(--text);
            font-weight: 300;
        }

        .system-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .stat-item b {
            color: var(--text);
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .card.log-card {
            flex: 1;
            min-height: 400px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            text-align: center;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            display: block;
            margin: 0.25rem 0;
        }

        .stat-card .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
        }

        .stat-card.pending .value {
            color: var(--warning);
        }

        .stat-card.completed .value {
            color: var(--success);
        }

        .stat-card.error .value {
            color: var(--error);
        }

        /* Event Log */
        .log-container {
            flex: 1;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .event-row {
            display: grid;
            grid-template-columns: 80px 150px 1fr 100px;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
            transition: background 0.2s;
        }

        .event-row:hover {
            background: rgba(88, 166, 255, 0.05);
        }

        .status-pill {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .status-pill.pending {
            background: rgba(210, 153, 34, 0.15);
            color: var(--warning);
            border: 1px solid rgba(210, 153, 34, 0.3);
        }

        .status-pill.completed {
            background: rgba(46, 160, 67, 0.15);
            color: var(--success);
            border: 1px solid rgba(46, 160, 67, 0.3);
        }

        .status-pill.failed {
            background: rgba(248, 81, 73, 0.15);
            color: var(--error);
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        /* Simulations */
        .btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn:hover {
            border-color: var(--primary);
            background: #1f242c;
        }

        .btn i {
            color: var(--primary);
            margin-right: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
            font-weight: 600;
            border: none;
            text-align: center;
        }

        .btn-primary:hover {
            background: #79c0ff;
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        .producer-node {
            font-size: 0.65rem;
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg);
            color: var(--text-dim);
            text-align: center;
            transition: all 0.3s;
            min-width: 40px;
        }

        .producer-node.active {
            border-color: var(--success);
            color: var(--success);
            background: rgba(46, 160, 67, 0.1);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-dim);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">‚ö° Transactional <span>Outbox Hub</span></div>
            <div class="system-stats" id="system-stats">
                <div class="stat-item">Workers: <b id="workers-count">0</b></div>
                <div class="stat-item">Uptime: <b id="uptime">0s</b></div>
                <div class="stat-item">Memory: <b id="memory">0MB</b></div>
                <div class="stat-item">Status: <b id="status" class="pulse" style="color: var(--success)">ACTIVE</b>
                </div>
            </div>
        </header>

        <div class="stats-row">
            <div class="card stat-card pending">
                <span class="label">Pending</span>
                <span class="value" id="count-pending">0</span>
            </div>
            <div class="card stat-card completed">
                <span class="label">Completed</span>
                <span class="value" id="count-completed">0</span>
            </div>
            <div class="card stat-card error">
                <span class="label">Dead Letter</span>
                <span class="value" id="count-dead">0</span>
            </div>
            <div class="card stat-card">
                <span class="label">Producers</span>
                <span class="value" id="count-producers">0</span>
            </div>
        </div>

        <!-- NEW FLOW VISUALIZER -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-title">Event Lifecycle Pipeline</div>
            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; position: relative;">
                <div
                    style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--border); z-index: 1;">
                </div>

                <div class="stat-card"
                    style="z-index: 2; background: var(--surface); padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; min-width: 120px;">
                    <span class="label"
                        style="display: block; margin-bottom: 0.5rem; border-bottom: 1px solid var(--border); padding-bottom: 4px;">1.
                        Producers</span>
                    <div id="producer-container"
                        style="display: flex; justify-content: center; flex-wrap: wrap; gap: 0.25rem;">
                        <!-- Dynamic nodes -->
                    </div>
                    <div id="flow-prod-status"
                        style="font-size: 0.6rem; margin-top: 0.5rem; text-align: center; color: var(--text-dim)">
                        LISTENING</div>
                </div>

                <div class="stat-card"
                    style="z-index: 2; background: var(--surface); padding: 1rem; border: 1px solid var(--border); border-radius: 8px;">
                    <span class="label">2. Outbox (DB)</span>
                    <div id="flow-db" style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--primary)">EMPTY</div>
                </div>

                <div class="stat-card"
                    style="z-index: 2; background: var(--surface); padding: 1rem; border: 1px solid var(--border); border-radius: 8px;">
                    <span class="label">3. Consumer (Worker)</span>
                    <div id="flow-cons" style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--accent)">LISTENING
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                    Live Event Lifecycle Log
                    <div class="pagination-controls" style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn" id="btn-live"
                            style="margin-bottom: 0; padding: 4px 8px; font-size: 0.65rem; background: var(--success); color: #000; display: none;"
                            onclick="resetToLive()">üü¢ LIVE</button>
                        <button class="btn" id="page-newer"
                            style="margin-bottom: 0; padding: 4px 12px; font-size: 0.75rem; border-color: var(--accent); display: none;"
                            onclick="loadNewer()">‚Üê Newer</button>
                        <button class="btn" id="page-older"
                            style="margin-bottom: 0; padding: 4px 12px; font-size: 0.75rem; border-color: var(--accent); display: none;"
                            onclick="loadOlder()">Older ‚Üí</button>
                    </div>
                </div>
                <div class="log-container" id="event-log">
                    <div style="text-align: center; color: var(--text-dim); padding: 2rem;">Connecting to outbox...
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="card">
                    <div class="card-title">Simulate Scenarios</div>

                    <div style="margin-bottom: 1.5rem;">
                        <span class="label" style="font-size: 0.7rem; display: block; margin-bottom: 0.5rem;">Standard
                            Flow</span>
                        <button class="btn" onclick="simulate('order', 'success')" id="sim-order-success">‚úÖ Success Case
                            (Order)</button>
                        <button class="btn" onclick="simulateConcurrency()" id="sim-concurrency"
                            style="border-color: var(--accent); color: var(--accent)">üî• Concurrency Stress</button>
                        <button class="btn" onclick="purgeDb()" id="sim-purge"
                            style="border-color: var(--success); color: var(--success)">üßπ Purge Processed
                            Events</button>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <span class="label" style="font-size: 0.7rem; display: block; margin-bottom: 0.5rem;">Producer
                            Fleet</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="addProducer()" id="sim-add-producer-fleet">‚ûï Add
                                Producer</button>
                            <button class="btn" onclick="removeProducer()" id="sim-remove-producer-fleet">‚ûñ Remove
                                Producer</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <span class="label" style="font-size: 0.7rem; display: block; margin-bottom: 0.5rem;">Failure
                            Scenarios</span>
                        <button class="btn" onclick="simulate('order', 'retry')" id="sim-order-retry"
                            style="border-color: var(--warning)">üîÅ Retry Sequence (3x)</button>
                        <button class="btn" onclick="simulate('payment', 'fail')" id="sim-payment-fail"
                            style="border-color: var(--error)">üíÄ Fatal Failure (DLE)</button>
                    </div>

                    <div style="margin-bottom: 0;">
                        <span class="label" style="font-size: 0.7rem; display: block; margin-bottom: 0.5rem;">Chaos &
                            Load</span>
                        <button class="btn" onclick="toggleSlow()" id="btn-toggle-slow">
                            <i id="icon-slow">üêå</i> Slow Consumer: <b id="status-slow">OFF</b>
                        </button>
                        <button class="btn" onclick="toggleTraffic()" id="btn-toggle-traffic">
                            <i id="icon-traffic">üöó</i> Background Traffic: <b id="status-traffic">OFF</b>
                        </button>
                        <button class="btn" onclick="toggleCdc()" id="btn-toggle-cdc">
                            <i id="icon-cdc">üß¨</i> Replication Slot: <b id="status-cdc">OFF</b>
                        </button>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <span class="label" style="font-size: 0.7rem; display: block; margin-bottom: 0.5rem;">Heavy
                            Stress Tests ‚öîÔ∏è</span>
                        <button class="btn" onclick="runStress('bloat')" id="btn-stress-bloat">
                            üí£ Trigger DB Bloat
                        </button>
                        <button class="btn" onclick="runStress('burst')" id="btn-stress-burst">
                            üé¢ High-Burst (1k events)
                        </button>
                        <button class="btn" onclick="runStress('sequence-stress')" id="btn-stress-seq">
                            üìâ Stress Sequence Gauge
                        </button>
                        <button class="btn" onclick="runStress('partitions')" id="btn-stress-part">
                            üß© Create Demo Partitions
                        </button>
                    </div>

                    <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 1rem;">
                        Select a mode to inject specific behaviors into the worker processing logic.
                    </p>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-title">Infrastructure</div>
                    <a href="http://localhost:9090/targets" target="_blank" class="btn">üìà Prometheus Targets</a>
                    <a href="http://localhost:3001/d/outbox-unified" target="_blank" class="btn">üìä Grafana
                        Deep-link</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const stats = {
            pending: document.getElementById('count-pending'),
            completed: document.getElementById('count-completed'),
            dead: document.getElementById('count-dead'),
            producers: document.getElementById('count-producers'),
            workers: document.getElementById('workers-count'),
            uptime: document.getElementById('uptime'),
            memory: document.getElementById('memory'),
        };

        let producerNodeMap = {}; // Map producerId to node element

        const flow = {
            prodStatus: document.getElementById('flow-prod-status'),
            prodContainer: document.getElementById('producer-container'),
            db: document.getElementById('flow-db'),
            cons: document.getElementById('flow-cons'),
        };

        const eventLog = document.getElementById('event-log');
        const btnNewer = document.getElementById('page-newer');
        const btnOlder = document.getElementById('page-older');
        const btnLive = document.getElementById('btn-live');

        // State Management
        let paginationState = {
            firstId: null,
            lastId: null,
            latestHeadId: null, // Track the newest seen ID to know when we are back at the top
            hasMore: false,
            atStart: true,
            isPolling: true
        };

        async function updateDashboard() {
            try {
                // 1. Always update Global Stats
                const statsRes = await fetch('/api/stats');
                const statsData = await statsRes.json();

                stats.pending.innerText = statsData.pendingEvents;
                stats.completed.innerText = statsData.completedEvents;
                stats.dead.innerText = statsData.deadLetterEvents;
                stats.producers.innerText = statsData.producers;
                stats.workers.innerText = statsData.workers;
                stats.uptime.innerText = statsData.uptime + 's';
                stats.memory.innerText = statsData.memory;

                flow.db.innerText = statsData.pendingEvents > 0 ? statsData.pendingEvents + ' PENDING' : 'EMPTY';
                flow.db.style.color = statsData.pendingEvents > 0 ? 'var(--warning)' : 'var(--primary)';

                // 1.5 Update Dynamic Producer Nodes
                renderProducerNodes(statsData.producerList || []);

                // 1.8 Update Simulation State
                const simStateRes = await fetch('/api/simulation-state');
                const simState = await simStateRes.json();

                document.getElementById('status-slow').innerText = simState.isSlowConsumer ? 'ACTIVE' : 'OFF';
                document.getElementById('status-slow').style.color = simState.isSlowConsumer ? 'var(--warning)' : 'inherit';
                document.getElementById('btn-toggle-slow').style.borderColor = simState.isSlowConsumer ? 'var(--warning)' : 'var(--border)';

                document.getElementById('status-traffic').innerText = simState.isBackgroundBusy ? 'ON' : 'OFF';
                document.getElementById('status-traffic').style.color = simState.isBackgroundBusy ? 'var(--success)' : 'inherit';
                document.getElementById('btn-toggle-traffic').style.borderColor = simState.isBackgroundBusy ? 'var(--success)' : 'var(--border)';

                document.getElementById('status-cdc').innerText = simState.isCdcActive ? 'ACTIVE' : 'OFF';
                document.getElementById('status-cdc').style.color = simState.isCdcActive ? 'var(--primary)' : 'inherit';
                document.getElementById('btn-toggle-cdc').style.borderColor = simState.isCdcActive ? 'var(--primary)' : 'var(--border)';

                // 2. Fetch Events (only auto-refresh if at start of log)
                if (paginationState.atStart && paginationState.isPolling) {
                    await fetchEvents();
                } else {
                    updatePaginationUI();
                }
            } catch (err) {
                console.error('Dashboard heartbeat failed:', err);
            }
        }

        async function toggleSlow() {
            await fetch('/api/toggle-slow', { method: 'POST' });
            updateDashboard();
        }

        async function toggleTraffic() {
            await fetch('/api/toggle-traffic', { method: 'POST' });
            updateDashboard();
        }

        async function toggleCdc() {
            await fetch('/api/toggle-cdc', { method: 'POST' });
            updateDashboard();
        }

        async function runStress(mode) {
            const btnMap = {
                'bloat': 'btn-stress-bloat',
                'burst': 'btn-stress-burst',
                'sequence-stress': 'btn-stress-seq',
                'partitions': 'btn-stress-part'
            };
            const btnId = btnMap[mode];
            const btn = document.getElementById(btnId);
            const originalText = btn.innerText;

            btn.innerText = '‚ö° EXECUTING...';
            btn.disabled = true;

            try {
                const res = await fetch(`/api/simulate-${mode}`, { method: 'POST' });
                if (res.ok) {
                    if (mode === 'bloat') {
                        btn.innerText = 'üß® LIVE BLOAT [20s]';
                        setTimeout(() => {
                            btn.innerText = '‚úÖ DEAD TUPLES READY';
                            setTimeout(() => {
                                btn.innerText = originalText;
                                btn.disabled = false;
                            }, 5000);
                        }, 20000);
                        return;
                    }
                    btn.innerText = '‚úÖ DONE!';
                } else {
                    btn.innerText = '‚ùå FAILED';
                }
            } catch (err) {
                console.error('Stress test failed:', err);
                btn.innerText = '‚ùå ERROR';
            } finally {
                // If it's NOT bloat OR if bloat reached the catch/else (didn't return in success)
                // we reset the button state after a period.
                if (mode !== 'bloat' || btn.innerText.includes('‚ùå')) {
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }, 3000);
                }
            }
        }

        async function fetchEvents(params = '') {
            try {
                const res = await fetch('/api/events' + params);
                const data = await res.json();

                paginationState.firstId = data.pagination.firstId;
                paginationState.lastId = data.pagination.lastId;
                paginationState.hasMore = data.pagination.hasMore;

                // When auto-polling the head, update the trackable latestHeadId
                if (params === '') {
                    paginationState.latestHeadId = data.pagination.firstId;
                }

                // If navigating newer, check if we reached the head
                if (params.includes('after=')) {
                    // If moving newer and we get no newer events (hasMore=false), or we reached/passed the latest seen head
                    if (!data.pagination.hasMore || (paginationState.latestHeadId && Number(data.pagination.firstId) >= Number(paginationState.latestHeadId))) {
                        paginationState.atStart = true;
                        paginationState.isPolling = true;
                    }
                }

                // Lifecycle visualization based on ANY event processing
                const hasProcessing = data.events.some(e => e.status === 'PROCESSING');
                flow.cons.innerText = hasProcessing ? 'PROCESSING...' : 'LISTENING';
                flow.cons.style.color = hasProcessing ? 'var(--accent)' : 'var(--text-dim)';
                if (hasProcessing) flow.cons.classList.add('pulse');
                else flow.cons.classList.remove('pulse');

                renderEvents(data.events);
                updatePaginationUI();
            } catch (err) {
                console.error('Failed to fetch events:', err);
            }
        }

        function renderProducerNodes(producerList) {
            // Only re-render if the list changed
            const currentIds = Object.keys(producerNodeMap).sort().join(',');
            const newIds = producerList.sort().join(',');

            if (currentIds === newIds) return;

            flow.prodContainer.innerHTML = '';
            producerNodeMap = {};

            producerList.forEach(id => {
                const node = document.createElement('div');
                node.id = `flow-prod-${id}`;
                node.className = 'producer-node';
                node.innerText = `P-${id.split('-')[1]}`;
                flow.prodContainer.appendChild(node);
                producerNodeMap[id] = node;
            });
        }

        async function addProducer() {
            const btn = document.getElementById('sim-add-producer-fleet');
            const originalText = btn.innerText;
            btn.innerText = '‚ûï ADDING...';
            btn.disabled = true;

            try {
                await fetch('/api/producers/add', { method: 'POST' });
                await updateDashboard();
            } finally {
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 500);
            }
        }

        async function removeProducer() {
            const btn = document.getElementById('sim-remove-producer-fleet');
            const originalText = btn.innerText;
            btn.innerText = '‚ûñ REMOVING...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/producers/remove', { method: 'POST' });
                const data = await res.json();
                if (!data.success) {
                    alert('Cannot remove the last producer!');
                }
                await updateDashboard();
            } finally {
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 500);
            }
        }

        function renderEvents(events) {
            if (!events.length) {
                eventLog.innerHTML = '<div style="text-align: center; color: var(--text-dim); padding: 2rem;">No events found in this range.</div>';
                return;
            }

            eventLog.innerHTML = events.map(e => `
                <div class="event-row" style="${e.status === 'PROCESSING' ? 'background: rgba(188, 140, 255, 0.1); border-left: 2px solid var(--accent);' : ''}">
                    <div style="display: flex; flex-direction: column; width: 45px; align-items: start; margin-right: 10px;">
                        <span style="color: var(--text-dim); font-size: 0.7rem;">#${e.id}</span>
                        <span style="font-size: 0.5rem; background: rgba(0, 243, 255, 0.1); color: var(--primary); padding: 1px 4px; border-radius: 4px; margin-top: 4px; white-space: nowrap;">${e.producerId.split('-')[1] || 'S'}</span>
                    </div>
                    <span style="color: var(--primary); font-weight: 500;">${e.eventType}</span>
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${e.aggregateType}: ${e.aggregateId}</span>
                        ${e.lastError ? `<span class="pulse" style="color: var(--error); font-size: 0.65rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${e.lastError}</span>` : ''}
                        ${e.retryCount > 0 ? `<span style="color: var(--warning); font-size: 0.65rem;">Attempts: ${e.retryCount}</span>` : ''}
                    </div>
                    <span class="status-pill ${e.status.toLowerCase()}">${e.status}</span>
                </div>
            `).join('');
        }

        async function loadOlder() {
            paginationState.atStart = false;
            paginationState.isPolling = false;
            await fetchEvents(`?before=${paginationState.lastId}`);
        }

        async function loadNewer() {
            if (!paginationState.firstId) return;
            await fetchEvents(`?after=${paginationState.firstId}`);

            // Logic to detect if we are back at page 1
            // In a real Keyset pagination, if we fetch 'after' and get < limit, 
            // but for simplicity, we'll reset if the newer button is clicked 
            // and we end up where atStart might be true.
            // Let's improve it: if after fetch we have no newer, we are at start.
            // But Keyset is tricky without a 'hasNewer' flag.
            // Simplest: If they click newer enough times, we'll just check if we can resume.
            // For now, let's just make 'Newer' work and allow 'LIVE' to reset.
        }

        async function resetToLive() {
            paginationState.atStart = true;
            paginationState.isPolling = true;
            await fetchEvents();
        }

        function updatePaginationUI() {
            btnOlder.style.display = paginationState.hasMore ? 'block' : 'none';
            btnNewer.style.display = paginationState.atStart ? 'none' : 'block';
            btnLive.style.display = (paginationState.isPolling || paginationState.atStart) ? 'none' : 'block';
        }

        async function simulateConcurrency() {
            const btn = document.getElementById('sim-concurrency');
            const originalText = btn.innerText;
            btn.innerText = 'üî• STRESSING...';
            btn.disabled = true;

            flow.prodStatus.innerText = 'BURSTING...';
            Object.values(producerNodeMap).forEach(p => p.classList.add('active', 'pulse'));

            try {
                await fetch('/api/simulate-concurrency', { method: 'POST' });
                await resetToLive();
                setTimeout(() => {
                    flow.prodStatus.innerText = 'LISTENING';
                    Object.values(producerNodeMap).forEach(p => p.classList.remove('active', 'pulse'));
                    updateDashboard();
                }, 1000);
            } finally {
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        async function purgeDb() {
            const btn = document.getElementById('sim-purge');
            const originalText = btn.innerText;
            btn.innerText = 'üßπ PURGING...';
            btn.disabled = true;

            try {
                await fetch('/api/cleanup', { method: 'POST' });
                await resetToLive();
                setTimeout(() => updateDashboard(), 500);
            } finally {
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 1000);
            }
        }

        async function simulate(type, mode) {
            const btnId = 'sim-' + type + '-' + (mode || 'success');
            const btn = document.getElementById(btnId) || document.getElementById('sim-' + type);
            const originalText = btn.innerText;

            btn.innerText = '‚ö° PRODUCING...';
            btn.disabled = true;
            flow.prodStatus.innerText = 'INSERTING...';

            try {
                const res = await fetch(`/api/simulate?type=${type}&mode=${mode}`, { method: 'POST' });
                const data = await res.json();

                const producerId = data.producerId;
                const producerNode = producerNodeMap[producerId];

                if (producerNode) {
                    producerNode.classList.add('active', 'pulse');
                }

                paginationState.atStart = true;
                paginationState.isPolling = true;

                setTimeout(() => {
                    flow.prodStatus.innerText = 'LISTENING';
                    if (producerNode) producerNode.classList.remove('active', 'pulse');
                    updateDashboard();
                }, 1000);
            } finally {
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 1500);
            }
        }

        // Initial update and polling
        updateDashboard();
        setInterval(updateDashboard, 1000); 
    </script>
</body>

</html>